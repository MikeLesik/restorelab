---
export interface Props {
  t: Record<string, any>;
}

const { t } = Astro.props;

const markers = [
  { name: 'Lisbon',   note: 'City & greater area',  lat: 38.7169, lng: -9.1399 },
  { name: 'Cascais',  note: 'All marinas covered',   lat: 38.6979, lng: -9.4215 },
  { name: 'Sintra',   note: 'Including Estoril',     lat: 38.7978, lng: -9.3878 },
  { name: 'Oeiras',   note: 'Business & residential',lat: 38.6969, lng: -9.3147 },
  { name: 'Almada',   note: 'South bank',            lat: 38.6769, lng: -9.1573 },
  { name: 'Setúbal',  note: 'On request',            lat: 38.5244, lng: -8.8882 },
];
---

<section class="py-24">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-16 items-center">

      <!-- Text -->
      <div>
        <h2 class="section-title">{t.area.section_title}</h2>
        <p class="section-subtitle mb-10">{t.area.section_subtitle}</p>

        <div class="grid grid-cols-2 gap-3">
          {t.area.areas.map((area: any) => (
            <div class="flex items-center gap-3 p-4 bg-white/3 border border-white/8 rounded-xl">
              <div class="w-2 h-2 bg-brand-accent rounded-full flex-shrink-0"></div>
              <div>
                <div class="text-white font-medium text-sm">{area.name}</div>
                <div class="text-white/35 text-xs">{area.note}</div>
              </div>
            </div>
          ))}
        </div>
      </div>

      <!-- Leaflet Map -->
      <div class="relative">
        <div class="rounded-3xl overflow-hidden border border-white/10 shadow-2xl" style="height: 460px;">
          <div id="service-map" style="width:100%; height:100%;"></div>
        </div>
        <!-- Decorative glow -->
        <div class="absolute inset-0 -z-10 blur-3xl opacity-15 bg-brand-accent rounded-3xl pointer-events-none"></div>
      </div>

    </div>
  </div>
</section>

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>

<script define:vars={{ markers }}>
  // Lazy-load Leaflet JS only when map enters viewport
  const mapEl = document.getElementById('service-map');
  if (!mapEl) return;

  const observer = new IntersectionObserver((entries) => {
    if (!entries[0].isIntersecting) return;
    observer.disconnect();
    initMap();
  }, { threshold: 0.1 });
  observer.observe(mapEl);

  function initMap() {
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    script.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV/XN/WLs=';
    script.crossOrigin = '';
    script.onload = () => buildMap();
    document.head.appendChild(script);
  }

  function buildMap() {
    const L = window.L;

    // Dark tile layer — CartoDB Dark Matter (free, no API key)
    const map = L.map('service-map', {
      center: [38.68, -9.28],
      zoom: 10,
      zoomControl: true,
      scrollWheelZoom: false,   // не мешает скроллу страницы
    });

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19,
    }).addTo(map);

    // Custom branded marker icon
    const makeIcon = (active) => L.divIcon({
      className: '',
      html: `
        <div style="
          width: 36px; height: 36px;
          background: ${active ? '#2A7FFF' : '#1B3A5C'};
          border: 2px solid ${active ? '#60a5fa' : '#2A7FFF'};
          border-radius: 50% 50% 50% 0;
          transform: rotate(-45deg);
          box-shadow: 0 2px 12px rgba(42,127,255,0.5);
          transition: background 0.2s;
        ">
          <div style="
            width: 10px; height: 10px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
          "></div>
        </div>`,
      iconSize: [36, 36],
      iconAnchor: [18, 36],
      popupAnchor: [0, -38],
    });

    // Popup styles injected once
    const style = document.createElement('style');
    style.textContent = `
      .leaflet-popup-content-wrapper {
        background: #0D1B2A;
        border: 1px solid rgba(42,127,255,0.3);
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        padding: 0;
      }
      .leaflet-popup-content {
        margin: 12px 16px;
        color: white;
        font-family: Inter, sans-serif;
      }
      .leaflet-popup-tip {
        background: #0D1B2A;
      }
      .leaflet-popup-close-button {
        color: rgba(255,255,255,0.4) !important;
        font-size: 18px !important;
        top: 6px !important;
        right: 8px !important;
      }
      .leaflet-control-zoom a {
        background: #0D1B2A !important;
        color: white !important;
        border-color: rgba(255,255,255,0.1) !important;
      }
      .leaflet-control-zoom a:hover {
        background: #1B3A5C !important;
      }
      .leaflet-control-attribution {
        background: rgba(10,10,10,0.7) !important;
        color: rgba(255,255,255,0.3) !important;
        font-size: 10px !important;
      }
      .leaflet-control-attribution a { color: rgba(255,255,255,0.4) !important; }
    `;
    document.head.appendChild(style);

    // Add markers
    markers.forEach((m) => {
      const marker = L.marker([m.lat, m.lng], { icon: makeIcon(true) });
      marker.bindPopup(`
        <div style="min-width:140px">
          <div style="font-weight:600; font-size:14px; color:white; margin-bottom:4px">${m.name}</div>
          <div style="font-size:12px; color:rgba(255,255,255,0.5)">${m.note}</div>
        </div>
      `);
      marker.addTo(map);
    });

    // Fit map to markers bounds with padding
    const group = L.featureGroup(
      markers.map(m => L.marker([m.lat, m.lng]))
    );
    map.fitBounds(group.getBounds().pad(0.2));
  }
</script>
