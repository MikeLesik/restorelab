---
export interface Props {
  t: Record<string, any>;
  lang: string;
}

const { t, lang } = Astro.props;

const cases = [
  {
    id: 1,
    title: 'BMW 3 Series — Paint Correction',
    category: 'car',
    before: '/images/cases/car1-before.jpg',
    after: '/images/cases/car1-after.jpg',
    result: 'Swirl marks eliminated, deep gloss restored',
    metric: '95% clarity',
    location: 'Cascais',
  },
  {
    id: 2,
    title: 'Porsche Cayenne — Ceramic Prep',
    category: 'car',
    before: '/images/cases/car2-before.jpg',
    after: '/images/cases/car2-after.jpg',
    result: 'Full two-stage correction + ceramic coating',
    metric: 'Saved €900',
    location: 'Lisbon',
  },
  {
    id: 3,
    title: 'Windshield — Wiper Scratches',
    category: 'glass',
    before: '/images/cases/glass1-before.jpg',
    after: '/images/cases/glass1-after.jpg',
    result: 'Deep wiper marks removed',
    metric: 'Saved €380',
    location: 'Sintra',
  },
  {
    id: 4,
    title: '45ft Sailboat — Gelcoat Restore',
    category: 'yacht',
    before: '/images/cases/yacht1-before.jpg',
    after: '/images/cases/yacht1-after.jpg',
    result: 'Full oxidation removed, showroom finish',
    metric: 'Saved €3 200',
    location: 'Marina Cascais',
  },
  {
    id: 5,
    title: 'Yacht Acrylic Windows',
    category: 'acrylic',
    before: '/images/cases/car5-before.jpg',
    after: '/images/cases/car5-after.jpg',
    result: 'UV yellowing reversed, clarity restored',
    metric: '100% clarity',
    location: 'Marina Lisboa',
  },
  {
    id: 6,
    title: 'Mercedes GLE — Scratch Removal',
    category: 'car',
    before: '/images/cases/car3-before.jpg',
    after: '/images/cases/car3-after.jpg',
    result: 'Deep scratch corrected — no repainting',
    metric: 'Saved €1 100',
    location: 'Oeiras',
  },
];

// Visual config per category — matches ServicesGrid color system
const categoryConfig: Record<string, { grad: string; iconPaths: string; color: string }> = {
  car: {
    grad: 'from-brand-accent/20 via-brand-navy to-brand-dark',
    color: 'text-brand-accent',
    iconPaths: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 11l2-5h10l2 5M3 11h18v4a1 1 0 01-1 1H4a1 1 0 01-1-1v-4z"/><circle cx="7.5" cy="17.5" r="1.5"/><circle cx="16.5" cy="17.5" r="1.5"/>`,
  },
  glass: {
    grad: 'from-cyan-500/20 via-brand-navy to-brand-dark',
    color: 'text-cyan-400',
    iconPaths: `<rect x="3" y="4" width="18" height="16" rx="2" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12h18M12 4v16"/>`,
  },
  yacht: {
    grad: 'from-teal-500/20 via-brand-navy to-brand-dark',
    color: 'text-teal-400',
    iconPaths: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 3v13M12 3L4 16h8zM12 7l6 9h-6zM2 20h20"/>`,
  },
  acrylic: {
    grad: 'from-violet-500/20 via-brand-navy to-brand-dark',
    color: 'text-violet-400',
    iconPaths: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>`,
  },
};
---

<section class="py-24">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

    <!-- Filter tabs -->
    <div class="flex flex-wrap gap-2 justify-center mb-10" id="case-filters" role="tablist" aria-label="Filter cases by category">
      {['all', 'car', 'glass', 'yacht', 'acrylic'].map((filter) => (
        <button
          data-filter={filter}
          role="tab"
          aria-selected={filter === 'all' ? 'true' : 'false'}
          class:list={[
            'px-4 py-2 rounded-full text-sm font-medium transition-colors border focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-accent focus-visible:ring-offset-2 focus-visible:ring-offset-brand-dark',
            filter === 'all'
              ? 'bg-brand-accent text-white border-brand-accent'
              : 'border-white/15 text-white/50 hover:text-white hover:border-white/30'
          ]}
        >
          {filter.charAt(0).toUpperCase() + filter.slice(1)}
        </button>
      ))}
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="cases-grid">
      {cases.map((c) => {
        const cfg = categoryConfig[c.category] || categoryConfig['car'];
        return (
          <div class="card group overflow-hidden hover:border-white/20 transition-all duration-300" data-category={c.category}>

            {c.before && c.after ? (
              /* Before/after slider — activated when real photos are added */
              <div
                class="relative aspect-video rounded-xl mb-4 overflow-hidden select-none"
                data-slider
                role="group"
                aria-label={`Before and after: ${c.title}`}
              >
                <img src={c.after} alt={`After — ${c.title}`} class="absolute inset-0 w-full h-full object-cover" width="640" height="360" loading="lazy" decoding="async" />
                <img src={c.before} alt={`Before — ${c.title}`} class="absolute inset-0 w-full h-full object-cover [clip-path:inset(0_50%_0_0)]" data-before-img width="640" height="360" loading="lazy" decoding="async" />
                <div class="absolute top-0 bottom-0 w-0.5 bg-white/80 shadow-lg left-1/2" data-divider>
                  <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-white rounded-full shadow-lg flex items-center justify-center cursor-ew-resize" role="slider" aria-label="Drag to compare before and after" aria-valuemin="0" aria-valuemax="100" aria-valuenow="50" tabindex="0">
                    <svg class="w-4 h-4 text-brand-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8 9l-3 3 3 3M16 9l3 3-3 3" /></svg>
                  </div>
                </div>
                <span class="absolute top-3 left-3 px-2 py-1 bg-black/60 backdrop-blur-sm rounded text-xs text-white/80 uppercase tracking-wider">Before</span>
                <span class="absolute top-3 right-3 px-2 py-1 bg-brand-accent/80 backdrop-blur-sm rounded text-xs text-white uppercase tracking-wider">After</span>
                <span class="absolute bottom-3 left-3 px-2 py-1 bg-black/60 backdrop-blur-sm rounded-md text-xs text-white/70 uppercase tracking-wider">{c.category}</span>
              </div>
            ) : (
              /* Premium gradient placeholder — matches service color system */
              <div class:list={['relative aspect-video rounded-xl mb-4 overflow-hidden bg-gradient-to-br', cfg.grad]}>
                {/* Grid dot pattern */}
                <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(circle, white 1px, transparent 1px); background-size: 20px 20px;"></div>

                {/* Before half */}
                <div class="absolute inset-y-0 left-0 w-1/2 flex flex-col items-center justify-center gap-2 border-r border-white/10">
                  <span class="label opacity-40">Before</span>
                  <div class="w-10 h-10 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center">
                    <svg class="w-5 h-5 text-white/20" fill="none" stroke="currentColor" viewBox="0 0 24 24" set:html={cfg.iconPaths} />
                  </div>
                </div>

                {/* After half */}
                <div class="absolute inset-y-0 right-0 w-1/2 flex flex-col items-center justify-center gap-2">
                  <span class="label opacity-60">After</span>
                  <div class:list={['w-10 h-10 rounded-xl border flex items-center justify-center', cfg.color.replace('text-', 'bg-').replace('400','500/20').replace('accent','accent/20'), 'border-current/20']}>
                    <svg class:list={['w-5 h-5', cfg.color]} fill="none" stroke="currentColor" viewBox="0 0 24 24" set:html={cfg.iconPaths} />
                  </div>
                </div>

                {/* Divider line */}
                <div class="absolute inset-y-0 left-1/2 w-px bg-white/20 flex items-center justify-center">
                  <div class="w-6 h-6 rounded-full bg-brand-dark border border-white/20 flex items-center justify-center">
                    <svg class="w-3 h-3 text-white/40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8 9l-3 3 3 3M16 9l3 3-3 3" /></svg>
                  </div>
                </div>

                {/* Metric badge */}
                <div class="absolute bottom-3 right-3">
                  <span class:list={['text-xs font-bold px-2.5 py-1 rounded-full bg-brand-dark/70 backdrop-blur-sm border border-white/10', cfg.color]}>
                    {c.metric}
                  </span>
                </div>

                {/* Category + location */}
                <div class="absolute top-3 left-3 flex items-center gap-1.5">
                  <span class="px-2 py-1 bg-black/50 backdrop-blur-sm rounded-md text-xs text-white/60 uppercase tracking-wider">{c.category}</span>
                  <span class="px-2 py-1 bg-black/50 backdrop-blur-sm rounded-md text-xs text-white/40">{c.location}</span>
                </div>
              </div>
            )}

            <h3 class="font-semibold text-white mb-1 text-sm">{c.title}</h3>
            <p class:list={['text-xs', cfg.color]}>{c.result}</p>
          </div>
        );
      })}
    </div>

    <!-- CTA -->
    <div class="text-center mt-16">
      <p class="text-white/40 text-sm mb-4">Want results like these?</p>
      <a href={`/${lang}/contact`} class="btn-primary">
        Get Your Free Estimate
      </a>
    </div>
  </div>
</section>

<script>
  /* Filters */
  const filterBtns = document.querySelectorAll('[data-filter]');
  const cards = document.querySelectorAll('[data-category]');

  filterBtns.forEach((btn) => {
    btn.addEventListener('click', () => {
      const filter = btn.getAttribute('data-filter');
      filterBtns.forEach((b) => {
        b.classList.remove('bg-brand-accent', 'text-white', 'border-brand-accent');
        b.classList.add('border-white/15', 'text-white/50');
        b.setAttribute('aria-selected', 'false');
      });
      btn.classList.add('bg-brand-accent', 'text-white', 'border-brand-accent');
      btn.classList.remove('border-white/15', 'text-white/50');
      btn.setAttribute('aria-selected', 'true');
      cards.forEach((card) => {
        const el = card as HTMLElement;
        el.style.display = (filter === 'all' || el.dataset.category === filter) ? '' : 'none';
      });
    });
  });

  /* Before/After slider */
  document.querySelectorAll('[data-slider]').forEach((slider) => {
    const el = slider as HTMLElement;
    const beforeImg = el.querySelector('[data-before-img]') as HTMLElement;
    const divider = el.querySelector('[data-divider]') as HTMLElement;
    const handle = divider?.querySelector('[role="slider"]') as HTMLElement;
    if (!beforeImg || !divider || !handle) return;

    let dragging = false;

    const setPosition = (clientX: number) => {
      const rect = el.getBoundingClientRect();
      let pct = ((clientX - rect.left) / rect.width) * 100;
      pct = Math.max(1, Math.min(99, pct));
      beforeImg.style.clipPath = `inset(0 ${100 - pct}% 0 0)`;
      divider.style.left = `${pct}%`;
      handle.setAttribute('aria-valuenow', String(Math.round(pct)));
    };

    handle.addEventListener('mousedown', (e) => { dragging = true; e.preventDefault(); });
    handle.addEventListener('touchstart', () => { dragging = true; }, { passive: true });

    // Keyboard support for slider
    handle.addEventListener('keydown', (e) => {
      const rect = el.getBoundingClientRect();
      const currentLeft = divider.offsetLeft;
      const currentPct = (currentLeft / rect.width) * 100;
      let newPct = currentPct;

      if (e.key === 'ArrowLeft' || e.key === 'ArrowDown') { newPct = Math.max(1, currentPct - 2); e.preventDefault(); }
      if (e.key === 'ArrowRight' || e.key === 'ArrowUp') { newPct = Math.min(99, currentPct + 2); e.preventDefault(); }

      if (newPct !== currentPct) {
        beforeImg.style.clipPath = `inset(0 ${100 - newPct}% 0 0)`;
        divider.style.left = `${newPct}%`;
        handle.setAttribute('aria-valuenow', String(Math.round(newPct)));
      }
    });

    window.addEventListener('mousemove', (e) => { if (dragging) setPosition(e.clientX); });
    window.addEventListener('touchmove', (e) => { if (dragging) setPosition(e.touches[0].clientX); }, { passive: true });
    window.addEventListener('mouseup', () => { dragging = false; });
    window.addEventListener('touchend', () => { dragging = false; });
  });
</script>
